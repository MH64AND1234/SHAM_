<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Nova AI Engine</title>

/* =======================
   GLOBAL STYLES
======================= */
<style>
*{box-sizing:border-box}
body{
 margin:0;
 background:#0f172a;
 color:#fff;
 font-family:system-ui,sans-serif;
}
.container{
 max-width:1000px;
 margin:auto;
 padding:20px;
}
h1{text-align:center;margin-bottom:10px}
#chatbox{
 background:#1e293b;
 height:550px;
 overflow-y:auto;
 padding:10px;
 border-radius:10px;
}
.msg{
 padding:10px;
 margin:6px;
 border-radius:12px;
 white-space:pre-wrap;
 word-break:break-word;
}
.user{background:#3b82f6;text-align:right}
.ai{background:#020617}
.system{background:#334155;font-size:13px}
textarea{
 width:100%;
 height:90px;
 background:#020617;
 color:white;
 border:none;
 border-radius:8px;
 padding:10px;
 resize:none;
}
button,select{
 background:#3b82f6;
 color:white;
 border:none;
 border-radius:8px;
 padding:10px;
 cursor:pointer;
}
button:hover{background:#2563eb}
.panel{
 display:flex;
 gap:6px;
 margin-top:6px;
 flex-wrap:wrap;
}
.typing{
 opacity:.6;
 font-style:italic;
 margin:5px;
}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<h1>ğŸ¤– Nova AI Engine</h1>

<div id="chatbox"></div>

<textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù..."></textarea>

<div class="panel">
<button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
<select id="mode">
 <option value="fast">âš¡ Ø³Ø±ÙŠØ¹</option>
 <option value="deep">ğŸ§  Ø¹Ù…ÙŠÙ‚</option>
 <option value="creative">ğŸ¨ Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</option>
</select>

<select id="persona">
 <option value="assistant">Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ø§Ù…</option>
 <option value="developer">Ù…Ø¨Ø±Ù…Ø¬</option>
 <option value="teacher">Ù…Ø¯Ø±Ø³</option>
 <option value="security">Ø®Ø¨ÙŠØ± Ø£Ù…Ù†ÙŠ</option>
</select>

<input type="file" id="file">
<button onclick="exportChat()">ØªØµØ¯ÙŠØ±</button>
<button style="background:#ef4444" onclick="clearChat()">Ù…Ø³Ø­</button>
</div>

</div>

<script>
/* =======================
   GLOBAL STATE
======================= */
const chatbox=document.getElementById("chatbox");
let lastSend=0;
let memory=JSON.parse(localStorage.getItem("nova_memory")||"[]");

/* =======================
   UTILITIES
======================= */
function addMsg(text,type="system"){
 const d=document.createElement("div");
 d.className="msg "+type;
 d.textContent=text;
 chatbox.appendChild(d);
 chatbox.scrollTop=chatbox.scrollHeight;
}

function sanitize(t){
 return t.replace(/<script.*?>.*?<\/script>/gi,"");
}

function compressContext(){
 let joined=memory.join("\n");
 if(joined.length>4000) joined=joined.slice(-4000);
 return joined;
}

/* =======================
   AI LOGIC
======================= */
function detectIntent(text){
 if(text.includes("Ø¹Ø¯Ù„")||file.files[0]) return "edit";
 if(text.includes("Ø´Ø±Ø­")) return "explain";
 if(text.includes("Ø®Ø·Ø£")) return "debug";
 return "chat";
}

function buildPrompt(userText){
 let mode=document.getElementById("mode").value;
 let persona=document.getElementById("persona").value;
 let intent=detectIntent(userText);

 let p="Ø£Ø¬Ø¨ Ø¨Ù†ÙØ³ Ù„ØºØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….\n";
 p+="Ù„Ø§ ØªØ®Ù…Ù‘Ù† ÙˆØ¥Ø°Ø§ Ù„Ù… ØªØ¹Ù„Ù… Ù‚Ù„ Ù„Ø§ Ø£Ø¹Ù„Ù….\n";

 if(mode==="deep") p+="Ø­Ù„Ù„ Ø¨Ø¹Ù…Ù‚.\n";
 if(mode==="creative") p+="ÙƒÙ† Ø¥Ø¨Ø¯Ø§Ø¹ÙŠÙ‹Ø§.\n";

 if(persona==="developer") p+="Ø£Ù†Øª Ù…Ø¨Ø±Ù…Ø¬ Ù…Ø­ØªØ±Ù.\n";
 if(persona==="teacher") p+="Ø£Ù†Øª Ù…Ø¯Ø±Ø³ ØªØ´Ø±Ø­ Ø¨Ø¨Ø³Ø§Ø·Ø©.\n";
 if(persona==="security") p+="Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.\n";

 if(intent==="edit") p+="Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø·.\n";
 if(intent==="debug") p+="Ø§Ø´Ø±Ø­ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ø­Ù„.\n";

 p+="\nØ§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚:\n"+compressContext()+"\n\n";
 p+="Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n"+userText;

 return p;
}

/* =======================
   MAIN SEND
======================= */
async function send(){
 if(Date.now()-lastSend<1500) return;
 lastSend=Date.now();

 let input=document.getElementById("input");
 let text=input.value.trim();
 let file=document.getElementById("file").files[0];
 if(!text && !file) return;

 addMsg(file?`ğŸ“ ${file.name}\n${text}`:text,"user");
 memory.push("USER:"+text);

 let typing=document.createElement("div");
 typing.className="typing";
 typing.textContent="Nova ÙŠÙÙƒØ±...";
 chatbox.appendChild(typing);

 let prompt=buildPrompt(text);

 if(file){
  if(file.size>2_000_000){alert("Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ±");return;}
  let content=await file.text();
  prompt+="\n\nÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù:\n"+content;
 }

 prompt=prompt.replace(/ignore previous/gi,"");

 let reply="âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„";
 try{
  const r=await fetch("https://api.novaapp.ai/api/chat/title/",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({messages:[{role:"user",content:prompt}]})
  });
  const d=await r.json();
  reply=d.choices?.[0]?.message?.content||reply;
 }catch(e){}

 reply=sanitize(reply);
 chatbox.removeChild(typing);

 addMsg(reply,"ai");
 memory.push("AI:"+reply);

 localStorage.setItem("nova_memory",JSON.stringify(memory));
 input.value="";
}

/* =======================
   EXTRA FEATURES
======================= */
function clearChat(){
 chatbox.innerHTML="";
 memory=[];
 localStorage.clear();
}

function exportChat(){
 let blob=new Blob([memory.join("\n\n")],{type:"text/plain"});
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="nova_chat.txt";
 a.click();
}

/* =======================
   INIT
======================= */
memory.forEach(m=>{
 addMsg(m.startsWith("USER:")?m.slice(5):m.slice(3),
 m.startsWith("USER:")?"user":"ai");
});
</script>
</body>
</html>